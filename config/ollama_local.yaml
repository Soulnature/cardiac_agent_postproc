# Ollama local configuration — uses ministral-3:14b (multimodal)
# Usage: python -m cardiac_agent_postproc.run --config config/ollama_local.yaml
#
# Prerequisites:
#   1. Install Ollama: https://ollama.com
#   2. Pull the model: ollama pull ministral-3:14b
#   3. Start Ollama server: ollama serve  (default: http://localhost:11434)

paths:
  source_dir: "/data484_5/xzhao14/cardiac_agent_postproc/results/Input_MnM2/all_frames_export"
  target_dir: "/data484_5/xzhao14/cardiac_agent_postproc/results/outputs"
  runs_subdir: "run_ollama_local"
  atlas_path: "shape_atlas.pkl"

solver:
  max_outer: 10
  topk_frac: 0.25
  topk_min: 20
  topk_max: 200
  max_inner: 15
  min_delta: 0.5
  min_quality_delta: 0.01
  patience: 5
  stop_min_rqs: 90.0
  stop_min_rqs_delta: 0.2
  stop_min_rqs_stagnant_rounds: 2
  skip_good_rqs_threshold: 75.0
  atlas_builder_min_rqs: 80.0

triage:
  enabled: true
  mode: "classifier"
  good_threshold: 0.95
  bad_threshold: 0.70
  vlm_enabled: false
  vlm_accept_threshold: 70

view_inference:
  rv_ratio_2ch_threshold: 0.02
  rv_ratio_rv_optional_threshold: 0.005

edge:
  sobel_percentile: 85
  overlap_target: 0.55

shape_atlas:
  enabled: true
  target_diag: 128
  kmeans_max: 4
  kmeans_min: 2
  per_view_divisor: 15
  min_samples_for_clustering: 5

reward_weights:
  use_surrogate: false
  surrogate_path: "surrogate_model.pkl"
  P_touch: 50.0
  P_edge_misalignment: 4.0
  P_components: 18.0
  P_islands: 20.0
  P_valve_leak: 5.0
  P_double_cavity: 30.0
  P_holes: 10.0
  P_size_drift: 2.0
  P_atlas_mismatch: 20.0
  P_atlas_lv_mismatch: 8.0
  P_lv_shape: 8.0
  P_shape_prior: 1.0
  P_slice_consistency: 5.0
  R_enclosure: 5.0
  R_shape_match: 15.0

ops:
  small_component_floor: 20
  small_component_frac: 0.002
  island_frac: 0.02
  morph_kernel3: 3
  smooth:
    contour_epsilon: 1.5
    gaussian_sigma: 1.0
    morph_r: 2

revision:
  enabled: false
  max_revisions: 30
  stop_min_dice: 0.90
  stop_max_hd95: 4.0
  stall_rounds: 5
  stall_min_dice_delta: 0.001
  stall_max_hd95_delta: 0.1

# ── LLM — Ollama local (ministral-3:14b, multimodal) ──
llm:
  enabled: true
  provider: "ollama"
  base_url: "http://localhost:11434/v1"
  api_key: "ollama"
  model: "ministral-3:14b"
  temperature: 0.15
  max_tokens: 8192
  timeout: 300

# ── VLM — same Ollama model (ministral-3:14b is multimodal) ──
vision_guardrail:
  enabled: true
  provider: "ollama"
  base_url: "http://localhost:11434/v1"
  api_key: "ollama"
  model: "ministral-3:14b"
  threshold: 60
  timeout: 600
  image_detail: "low"

quality_model:
  enabled: true
  path: "quality_model.pkl"
  blend_mode: "replace"
  blend_alpha: 0.5
  bad_threshold: 0.93
  log_features: false

diagnosis:
  enabled: true
  vlm_enabled: true
  spatial: true
  quality_threshold: 0.8
  max_suggestions: 4

# ── Multi-Agent System ──
multi_agent:
  max_rounds_per_case: 3
  fast_path_threshold: 0.95
  agent_temperature: 0.15
  enable_negotiation: true
  batch_summary: true

# ── Executor Safety Gates ──
executor:
  max_high_impact_change_ratio: 0.20
  max_step_change_ratio: 0.12
  same_verdict_max_change_ratio: 0.01

# ── Agent-specific overrides (all use local Ollama) ──
agents:
  triage:
    model: "ministral-3:14b"
    image_detail: "low"
    quality_model:
      enabled: true
      path: "quality_model.pkl"

  diagnosis:
    model: "ministral-3:14b"
    image_detail: "auto"
    vlm_enabled: true
    max_suggestions: 4

  planner:
    model: "ministral-3:14b"
    chain_of_thought: true

  verifier:
    model: "ministral-3:14b"
    image_detail: "auto"
