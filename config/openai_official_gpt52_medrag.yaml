paths:
  source_dir: "/data484_5/xzhao14/cardiac_agent_postproc/results/Input_MnM2/all_frames_export"
  target_dir: "/data484_5/xzhao14/cardiac_agent_postproc/results/outputs" # run script adds subdir
  runs_subdir: "run_v31_azure_openai_medrag"
  atlas_path: "shape_atlas.pkl"

# No-GT anatomy score: pre-fitted source distribution for view-aware quality scoring
anatomy_stats_path: "anatomy_stats_v2.pkl"

solver:
  max_outer: 10
  topk_frac: 0.25
  topk_min: 20
  topk_max: 200
  max_inner: 15
  min_delta: 0.5
  min_quality_delta: 0.01
  patience: 10
  stop_min_rqs: 90.0
  stop_min_rqs_stagnant_rounds: 2

  # Conditional Optimization
  skip_good_rqs_threshold: 75.0

triage:
  enabled: true
  mode: "classifier"          # "classifier" (trained model) or "heuristic" (feature-based)
  good_threshold: 0.92        # only used in heuristic mode
  bad_threshold: 0.70         # only used in heuristic mode
  vlm_enabled: false           # DISABLED: currently broken (returns 0)
  vlm_accept_threshold: 70

view_inference:
  rv_ratio_2ch_threshold: 0.02
  rv_ratio_rv_optional_threshold: 0.005

edge:
  sobel_percentile: 85
  overlap_target: 0.55

shape_atlas:
  enabled: true
  target_diag: 128
  kmeans_max: 4
  kmeans_min: 2
  per_view_divisor: 15
  min_samples_for_clustering: 5

reward_weights:
  use_surrogate: false
  surrogate_path: "surrogate_model.pkl"
  # Kept for atlas_builder and optional logging, NOT used in optimizer decisions
  P_touch: 50.0
  P_edge_misalignment: 4.0
  P_components: 18.0
  P_islands: 20.0
  P_valve_leak: 5.0
  P_double_cavity: 30.0
  P_holes: 10.0
  P_size_drift: 2.0
  P_atlas_mismatch: 20.0
  P_atlas_lv_mismatch: 8.0
  P_lv_shape: 8.0
  P_shape_prior: 1.0
  P_slice_consistency: 5.0
  R_enclosure: 5.0
  R_shape_match: 15.0

ops:
  small_component_floor: 20
  small_component_frac: 0.002
  island_frac: 0.02

  erosion_iterations: 1
  dilation_iterations: 1
  coupled_erosion_min_iters: 1
  max_erosion_loss: 0.25

  morph_kernel3: 3
  morph_close_large_kernel: 5
  gap_close_small_kernel: 3
  gap_close_large_kernel: 5
  gap_close_open_between: true
  gap_close_max_myo_growth_ratio: 0.12
  bridge_thickness: 2
  bridge_thickness_mild: 1
  bridge_thickness_strong: 3
  rv_lv_barrier_touch_iters: 3
  rv_lv_barrier_barrier_iters: 1
  rv_lv_barrier_touch_iters_mild: 2
  rv_lv_barrier_barrier_iters_mild: 1
  rv_lv_barrier_touch_iters_strong: 4
  rv_lv_barrier_barrier_iters_strong: 2
  rv_lv_barrier_max_new_myo_ratio: 0.04
  smooth:
    contour_epsilon: 1.5
    gaussian_sigma: 1.0
    morph_r: 1

revision:
  enabled: false              # disabled: VLM pipeline is single-pass
  max_revisions: 30
  stop_min_dice: 0.90
  stop_max_hd95: 4.0
  stall_rounds: 5
  stall_min_dice_delta: 0.001
  stall_max_hd95_delta: 0.1

llm:
  enabled: true
  provider: "ollama"            # "gemini" or "ollama" (base class uses 'ollama' logical provider for OpenAI compatible)
  base_url: "https://api.openai.com/v1"  # Azure OpenAI endpoint
  model: "gpt-5.2"
  # API key source: env AZURE_OPENAI_API_KEY (or set llm.api_key explicitly)
  temperature: 0.15
  max_tokens: 8192

# Visual-Language Model (using Azure OpenAI multimodal)
vision_guardrail:
  enabled: true
  provider: "ollama"            # "gemini" or "ollama" (base class uses 'ollama' logical provider for OpenAI compatible)
  base_url: "https://api.openai.com/v1"  # Azure OpenAI endpoint
  model: "gpt-5.2"
  # API key source: env AZURE_OPENAI_API_KEY (or set vision_guardrail.api_key explicitly)
  threshold: 40

quality_model:
  enabled: true
  path: "quality_model.pkl"
  blend_mode: "replace"  # none | hybrid | replace
  blend_alpha: 0.5
  bad_threshold: 0.93
  log_features: false

diagnosis:
  enabled: true
  vlm_enabled: true            # ENABLED: VLM spatial diagnosis
  spatial: true                # NEW: enable spatial output format
  quality_threshold: 0.8
  max_suggestions: 4           # reduced: focus on top issues

# ── Multi-Agent System ──
multi_agent:
  max_rounds_per_case: 2       # max diagnosis→plan→execute→verify cycles
  fast_path_threshold: 0.925    # cases above this skip the full pipeline
  agent_temperature: 0.2      # LLM temperature for agent reasoning
  enable_negotiation: true     # allow agents to challenge each other
  batch_summary: true          # cross-case learning after each batch
  strict_no_gt_online: false   # when true, online decisions cannot consume GT-derived values
  anatomy_llm_enable: true     # allow LLM to consume structured anatomy summaries
  anatomy_llm_top_k: 5         # number of top anatomy anomalies exposed to LLM
  anatomy_llm_scope: ["diagnosis", "planner", "verifier"]  # where anatomy summaries are injected
  approved_pick_llm_weight: 0.45      # approved-case final mask selection: online score weight
  approved_pick_anatomy_weight: 0.55  # approved-case final mask selection: anatomy score weight
  approved_pick_min_margin: 0.000001  # choose best_intermediate only if blended score exceeds current by margin
  nonapproved_pick_min_anatomy_gain: 0.25      # minimum anatomy-score gain vs original

# ── Executor Safety Gates ──
executor:
  max_high_impact_change_ratio: 0.07  # cap for atlas/neighbor/large/global ops
  max_step_change_ratio: 0.08         # cap for normal per-step edits
  same_verdict_max_change_ratio: 0.03 # if VLM says "same", only allow small low-impact edits
  same_verdict_min_compare_confidence: 0.70
  allow_borderline_on_same: true
  high_risk_unlock_change_ratio_scale: 1.20
  high_risk_unlock_max_ratio_cap: 0.18
  candidate_search_max_change_ratio: 0.10
  candidate_search_accept_score: 0.14
  anatomy_gate_enabled: true           # reject steps that significantly drop anatomy score
  anatomy_gate_drop_threshold: -8.0    # anatomy score drop (0-100 scale) that triggers rejection
  anatomy_gate_monotonic: true         # require per-step anatomy score to be non-degrading
  anatomy_gate_step_drop_tolerance: 0.5  # allowed per-step anatomy drop before rejection
  gate_optional_disappear_min_area_px: 80  # optional class disappearance is blocked if area is large
  gate_lv_myo_enable: true             # enforce LV boundary covered by Myo (valve region exempt)
  gate_valve_exempt_margin_px: 6       # top valve-plane margin exempt from LV-Myo coverage check
  gate_lv_myo_min_coverage: 0.76       # minimum LV-edge coverage by Myo outside valve region
  gate_lv_myo_allow_drop: 0.02         # reject when coverage drops more than this and below min

# ── Verifier Threshold Policy ──
verifier:
  knowledge_top_k: 2
  anatomy_hard_violation_reject: true  # deterministic reject when hard anatomy violations worsen
  anatomy_delta_reject_enable: true    # deterministic reject when anatomy score drops too much
  anatomy_delta_reject_threshold: -1.0 # reject when (after-before) < this threshold
  thresholds:
    reject: 45.0
    approve: 65.0
    per_view:
      2CH: {reject: 43.0, approve: 63.0}
      3CH: {reject: 45.0, approve: 65.0}
      4CH: {reject: 47.0, approve: 67.0}


# ---- Agent-specific overrides ----
agents:
  triage:
    provider: "ollama"
    base_url: "https://api.openai.com/v1"
    model: "gpt-5.2"
    image_detail: "auto"
    vlm_n_refs: 2
    vlm_ref_match_view: true
    vlm_good_prob_weight: 0.85
    qm_good_prob_weight: 0.15
    score_good_floor: 0.72
    score_bad_ceiling: 0.40
    quality_model:
      enabled: true
      path: "quality_model.pkl"

  diagnosis:
    provider: "ollama"
    base_url: "https://api.openai.com/v1"
    model: "gpt-5.2"
    image_detail: "auto"
    vlm_enabled: true
    max_suggestions: 4

  planner:
    provider: "ollama"
    base_url: "https://api.openai.com/v1"
    model: "gpt-5.2"
    chain_of_thought: true

  verifier:
    provider: "ollama"
    base_url: "https://api.openai.com/v1"
    model: "gpt-5.2"
    image_detail: "auto"
